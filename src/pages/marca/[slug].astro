---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { findBrand, getArticlesByBrand, getCategories, getSiteInfo } from '../../utils/data';

export async function getStaticPaths() {
  const { getBrands } = await import('../../utils/data');
  return getBrands().map((brand) => ({ params: { slug: brand.slug } }));
}

const { slug } = Astro.params;
const brand = findBrand(slug!);
const site = getSiteInfo();

if (!brand) {
  throw new Error(`Marca no encontrada: ${slug}`);
}

const articles = getArticlesByBrand(brand.slug);
const categories = getCategories().filter((category) => articles.some((a) => a.categoria === category.slug));
const url = `https://opinioneselectronicas.com/marca/${brand.slug}/`;

const brandSchema = {
  '@context': 'https://schema.org',
  '@type': 'Brand',
  name: brand.nombre,
  description: brand.metaDescription,
  url,
  logo: brand.logo
};
---
<BaseLayout
  title={brand.metaTitle}
  description={brand.metaDescription}
  image={brand.ogImage}
  url={url}
  keywords={[brand.nombre, 'reviews', 'comparativas']}
>
  <div class="container">
    <div class="hero">
      <div>
        <div class="badge">Marca</div>
        <h1>{brand.nombre}</h1>
        <p>{brand.descripcion}</p>
        <div class="tag-list">
          <span class="tag">Garantía</span>
          <span class="tag">Rendimiento</span>
          <span class="tag">Servicio técnico</span>
        </div>
      </div>
      <div class="card" style="text-align:center;">
        <img src={brand.logo} alt={`Logo ${brand.nombre}`} style="max-height:60px;object-fit:contain;margin-bottom:1rem;" />
        <p class="meta">Cobertura independiente con métricas de laboratorio y feedback de tienda.</p>
      </div>
    </div>

    <section>
      <div class="section-title">
        <h2>Artículos y reviews</h2>
        <span class="meta">{articles.length} publicaciones</span>
      </div>
      <div class="grid grid-3">
        {articles.map((article) => (
          <article class="card" key={article.slug}>
            <img class="cover-image" src={article.heroImage} alt={article.titulo} loading="lazy" />
            <div class="meta">Actualizado {article.actualizado}</div>
            <h3 style="margin:0.35rem 0;">{article.titulo}</h3>
            <p class="meta">{article.extracto}</p>
            <a class="button secondary" href={`/articulo/${article.slug}`}>Leer review</a>
          </article>
        ))}
      </div>
    </section>

    <section>
      <div class="section-title">
        <h2>Categorías relacionadas</h2>
      </div>
      <div class="grid grid-4">
        {categories.map((category) => (
          <div class="card" key={category.slug}>
            <h3 style="margin-top:0;">{category.nombre}</h3>
            <p class="meta">{category.resumen}</p>
            <a class="button secondary" href={`/categoria/${category.slug}`}>Ver comparativas</a>
          </div>
        ))}
      </div>
    </section>
  </div>
  <script type="application/ld+json" set:html={JSON.stringify(brandSchema)}></script>
</BaseLayout>
